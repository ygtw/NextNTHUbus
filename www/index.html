<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

    <title>清大小巴等等我</title>
    <link rel="stylesheet" href="jquery.mobile-1.3.2.min.css">
    <link rel="stylesheet" href="jqm-demos.css">

    <link rel="shortcut icon" href="favicon.ico">
    <script src="jquery.js"></script>
    <script src="jquery.mobile-1.3.2.min.js"></script>
    <script src="Std_StranJF.js"></script>
    <link rel="stylesheet" type="text/css" href="jquery.countdown.css">
    <script type="text/javascript" src="jquery.countdown.min.js"></script>



    <script type="text/javascript">
        var Alltime = 0;
        var storelink = "https://itunes.apple.com/us/app/qing-da-xia-yi-ban-xiao-ba/id785576310?ls=1&mt=8"

            function allOn(value) {
                Alltime = value;
                $("#tb").html("");
                getTime();

                if(value==1)
                {
                    $("#tbCDOWN").hide();
                    $("#alerts").hide();
                }
                else
                {
                    $("#tbCDOWN").show();
                    $("#alerts").show();

                }




                console.log("XD")
            }

            function Check_transCN() {
                var language = window.navigator.userLanguage || window.navigator.language;

                if (language.indexOf("CN") > -1 || language.indexOf("cn") > -1)
                    StranBody(document)
            }

        $(document).ready(function () {

            if (/Android|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                // some code..
                storelink = "https://play.google.com/store/apps/details?id=bstn.next.nthu.bus";
            }
            var language = window.navigator.userLanguage || window.navigator.language;
            //alert(language); //works IE/SAFARI/CHROME/FF
            if (language.indexOf("TW") == -1 && language.indexOf("CN") == -1 && language.indexOf("tw") == -1 && language.indexOf("cn") == -1)
                $("#headertitle").text("Next NTHU Bus");

            Check_transCN();


            getTime();


        });

        function getTime(argument) {
            $("#tb").html("");


            $.ajax({
                type: "GET",
                url: "time.csv",
                dataType: "text",
                success: function (data) {

                    var table = CSVToArray(data)
                    //   console.log(table)
                    var count = 0;
                    var Tcount = 0;
                    var currentdate = new Date();

                    var t_h = currentdate.getHours();
                    var t_m = currentdate.getMinutes();
                    var t_d = currentdate.getDay();
                    var Smart=0;


                    if (t_d == 0 && Alltime == 0) {
                        $("#alerts").html("<p style='text-align:center'><br>週日不開車 <br> Sunday No Car<br><br>◢  崩╰ (〒皿〒)╯ 潰 ◣<br><br><br><p>");
                        return;
                    }
                    if (t_d == 6 && Alltime == 0) {
                        var tempstring = "<tr>";

                        for (var i = 0; i < table.length - 1; i++) {

                            if (t_d != table[i][3]) continue;

                            tempstring = tempstring + "<td>" + table[i][0] + "</td>";
                            tempstring = tempstring + "<td>" + table[i][1] + "</td>";

                            tempstring = tempstring + "</tr>";

                        }
                        $("#tb").append(tempstring);

                        $("#alerts").html("<p style='text-align:center'><br>週六沒什麼車 <br> Saturday Only few Cars<br><br>( ′-`)y-～<br><br><br><p>");



                        return;
                    }

                    for (var i = 0; i < table.length - 1; i++) {

                        var tempstring = "<tr>";

                        var noCar = 0;

                        var j = 0;


                        // console.log(table[i][j])

                        t_Th = table[i][j].split(':')[0];
                        t_Tm = table[i][j].split(':')[1];


                        var date1 = new Date(currentdate.getFullYear(), currentdate.getMonth(), currentdate.getDate(), t_h, t_m); // 9:00 AM
                        var date2 = new Date(currentdate.getFullYear(), currentdate.getMonth(), currentdate.getDate(), t_Th, t_Tm); // 5:00 PM

                        if (date2 > date1 || Alltime == 1) { //avaliable


                            if (table[i][3] == 6 && Alltime) is6 = "<br>週一 ~ 週六 <BR>Monday-Saturday"
                            else is6 = "";


                            if (table[i][2] != "s" && table[i][2] != "e")
                                tempstring = tempstring + "<td >" + table[i][j] + is6 + "</td>";



                            count++;
                            //  console.log(count)

                            if (count == 1) {
                                //                                console.log(date2)
                                $('#GateCDown').countdown('destroy')

                                $('#GateCDown').countdown({
                                    until: date2,
                                    format: 'M',
                                                layout:'{mn}<br>分 mins',
                                    onExpiry: function () {
                                        getTime()
                                    }});


                                if (table[i][2] == "e") {
                                    Smart=1;

                                    $('#GateCDown').countdown('destroy')

                                    $('#GateCDown').countdown({
                                        until: new Date(),
                                        format: 'M',
                                                layout:'{mn}<br>分 mins',
                                onExpiry: function () {
                                            getTime()
                                        }
                                    });
                                    $('#TSMCDown').countdown('destroy')

                                    $('#TSMCCDown').countdown({
                                        until: new Date(),
                                        format: 'M',
                                                     layout:'{mn}<br>分 mins',
                           onExpiry: function () {
                                            getTime()
                                        }
                                    });
                                }

                            }

                            if (table[i][2] == "s") {
                                tempstring = tempstring + "<td colspan='2' style=''>" + table[i][j] + "<br> 機動發車開始<BR>SmartTime Start </td>";


                            }

                            if (table[i][2] == "e") {
                                tempstring = tempstring + "<td colspan='2' style=''>" + table[i][j] + "<br> 機動時段結束<BR>SmartTime End </td>";

                            }




                        } else if (table[i][1]) {
                            tempstring = tempstring + "<td style=' color:darkgrey'>" + table[i][j] + "</td>";
                            noCar++;
                            //  $("#tb").append("<td style='background:lightgray'>"+table[i][j]+"</td>");

                        }
                        //console.log(t_h+"  " + " "+table[i][j])


                        //////////////////////////////////////////////////////

                        var j = 1;

                        //                    console.log(table[i][2])


                        if (table[i][2].length == 0) {


                            t_Th = table[i][j].split(':')[0];
                            t_Tm = table[i][j].split(':')[1];

                            var date1 = new Date(currentdate.getFullYear(), currentdate.getMonth(), currentdate.getDate(), t_h, t_m); // 9:00 AM
                            var date2 = new Date(currentdate.getFullYear(), currentdate.getMonth(), currentdate.getDate(), t_Th, t_Tm); // 5:00 PM



                            if (date2 > date1 || Alltime == 1) { //avaliable
                                tempstring = tempstring + "<td>" + table[i][j] + "</td>";




                                Tcount++;
                                if (Tcount == 1 && Smart==0) {
                                    //                                console.log(date2+"@__@"+date1)
                                    $('#TSMCCDown').countdown('destroy')

                                    $('#TSMCCDown').countdown({
                                        until: date2,
                                        layout:'{mn}<br>分 mins',
                                        format: 'M',
                                        onExpiry: function () {
                                            getTime()
                                        }
                                    });

                                }


                            } else {
                                tempstring = tempstring + "<td style=' color:darkgrey'>" + table[i][j] + "</td>";
                                noCar++;
                                //  $("#tb").append("<td style='background:lightgray'>"+table[i][j]+"</td>");

                            }

                        }




                        if (noCar < 2) {
                            $("#tb").append(tempstring);

                        }




                        tempstring = tempstring + "</tr>";


                    };

                    if (count == 0 && Tcount == 0 && Alltime == 0 && t_d != 0) {
                        $("#tb").html();
                        $("#alerts").html("<p style='text-align:center'><br>沒車了 No Car<br><br>◢  崩╰ (〒皿〒)╯ 潰 ◣<br><br><br><p>");
                    }

                    Check_transCN()


                }

            });


        }



         // This will parse a delimited string into an array of
         // arrays. The default delimiter is the comma, but this
         // can be overriden in the second argument.

        function CSVToArray(strData, strDelimiter) {
            // Check to see if the delimiter is defined. If not,
            // then default to comma.
            strDelimiter = (strDelimiter || ",");

            // Create a regular expression to parse the CSV values.
            var objPattern = new RegExp(
                (
                    // Delimiters.
                    "(\\" + strDelimiter + "|\\r?\\n|\\r|^)" +

                    // Quoted fields.
                    "(?:\"([^\"]*(?:\"\"[^\"]*)*)\"|" +

                    // Standard fields.
                    "([^\"\\" + strDelimiter + "\\r\\n]*))"
                ),
                "gi"
            );


            // Create an array to hold our data. Give the array
            // a default empty first row.
            var arrData = [
                []
            ];

            // Create an array to hold our individual pattern
            // matching groups.
            var arrMatches = null;


            // Keep looping over the regular expression matches
            // until we can no longer find a match.
            while (arrMatches = objPattern.exec(strData)) {

                // Get the delimiter that was found.
                var strMatchedDelimiter = arrMatches[1];

                // Check to see if the given delimiter has a length
                // (is not the start of string) and if it matches
                // field delimiter. If id does not, then we know
                // that this delimiter is a row delimiter.
                if (
                    strMatchedDelimiter.length &&
                    (strMatchedDelimiter != strDelimiter)
                ) {

                    // Since we have reached a new row of data,
                    // add an empty row to our data array.
                    arrData.push([]);

                }


                // Now that we have our delimiter out of the way,
                // let's check to see which kind of value we
                // captured (quoted or unquoted).
                if (arrMatches[2]) {

                    // We found a quoted value. When we capture
                    // this value, unescape any double quotes.
                    var strMatchedValue = arrMatches[2].replace(
                        new RegExp("\"\"", "g"),
                        "\""
                    );

                } else {

                    // We found a non-quoted value.
                    var strMatchedValue = arrMatches[3];

                }


                // Now that we have our value string, let's add
                // it to the data array.
                arrData[arrData.length - 1].push(strMatchedValue);
            }

            // Return the parsed data.
            return (arrData);
        }
    </script>
    <style type="text/css">
        span.hasCountdown {
            border: 0px solid #ccc;
            background-color: transparent;
            line-height: 100%;
        }
        .ui-table th,
        .ui-table td {
            text-align: center;
            border-bottom: 1px #787878 solid;
        }
        body,
        .jqm-demos {
            background-color: none;
            -webkit-tap-highlight-color: none;
        }
        .ui-btn-active {
            color: #2F3E46 !important;
            background: none !important;
            background-color: none !important;
            text-shadow: 0
            /*{a-bup-shadow-x}*/
            1px
            /*{a-bup-shadow-y}*/
            0
            /*{a-bup-shadow-radius}*/
            #ffffff
            /*{a-bup-shadow-color}*/
            ;
        }
        .jqm-header {
            border-top: 0px;
        }
        td {
            width: 50%
        }
    </style>




</head>




<body>
    <div data-role="page" class="jqm-home" data-theme="a">

        <div data-role="header" data-theme="a" data-position="fixed" data-tap-toggle="false">
            <a href="dialog.html" data-rel="dialog" data-transition="pop" class="ui-icon-alt" data-theme="d" data-icon="info" data-iconpos="notext" data-inline="true">Home - Black icons, no disc</a>

            <h1 class="jqm-logo" id="headertitle">清大小巴等等我</h1>

            <a href="setting.html" data-rel="dialog" data-transition="pop" class="ui-icon-alt" data-theme="d" data-icon="gear" data-iconpos="notext" data-inline="true">Home - Black icons, no disc</a>


            <table data-role="table" id="table-custom-3" data-mode="table" class="ui-body-a ui-shadow table-stripe ui-responsive" data-column-btn-theme="c" data-column-btn-text="" data-column-popup-theme="b">

                <thead>
                    <tr class="ui-bar-d">
                        <th style="width:50%">校門口 Gate</th>
                        <th>台積館 TSMC</th>

                    </tr>
                </thead>
            </table>



        </div>
        <!-- /header -->


        <div id="content" data-role="content" class="jqm-content" style="margin-bottom:10%; padding-top:0px">

            <table data-role="table" id="table-custom-2" data-mode="table" class="ui-body-a ui-shadow table-stripe ui-responsive" data-column-btn-theme="c" data-column-btn-text="" data-column-popup-theme="b" style="font-size:150%">
                <tbody id="tbCDOWN" class="ui-bar-h">
                    <tr>
                        <td><span id="GateCDown" style=""></span>
                        </td>
                        <td><span id="TSMCCDown"></span>
                        </td>
                    </tr>
                </tbody>
            </table>

            <table data-role="table" id="table-custom-2" data-mode="table" class="ui-body-a ui-shadow table-stripe ui-responsive" data-column-btn-theme="c" data-column-btn-text="" data-column-popup-theme="b">
                <tbody id="tb" class="ui-bar-h">
                    <tr>
                        <td><span id="GateCDown"></span>
                        </td>
                        <td><span id="TSMCCDown"></span>
                        </td>
                    </tr>
                </tbody>
            </table>

            <div id="alerts"></div>


        </div>
        <!-- /content -->

        <div data-role="footer" class="jqm-footer" data-theme="d">
            <hr data-theme="d" />
            <p>Next NTHU Bus.</p>
        </div>
        <!-- /footer -->


    </div>
    <!-- /page -->
</body>

</html>
